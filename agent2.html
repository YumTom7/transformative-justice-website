<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Case Connector</title>
<meta name="robots" content="noindex,nofollow" />
<style>
  :root{ --fade:2200ms; --bg:#061c2b; --ink:#d9ecff; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--ink); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .stage{ position:relative; height:100%; overflow:hidden; }
  /* particle dot field (canvas sits behind) */
  #dots{ position:absolute; inset:0; }
  /* face */
  .faceWrap{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; }
  .face{ width:min(86vmin,720px); opacity:0; filter: blur(14px) saturate(1.15) drop-shadow(0 0 22px rgba(74,196,255,.28));
         transition: opacity var(--fade) ease, filter var(--fade) ease; }
  .started .face{ opacity:1; filter: blur(0); }
  /* SVG mouth overlay (positioned over the image center; tweak x/y/scale to fit your asset) */
  .mouthWrap{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(86vmin,720px); pointer-events:none; opacity:0; transition: opacity 600ms ease; }
  .started .mouthWrap{ opacity:1; }
  svg{ width:100%; height:auto; }
  .lip{ fill:#63c7ff22; stroke:#9ed0ff88; stroke-width:2; filter: drop-shadow(0 0 6px rgba(99,199,255,.5)); }
  .open{ transform-origin:50% 50%; animation: talk 280ms ease-in-out forwards; }
  @keyframes talk{
    0%{ transform: scaleY(0.3); }
    50%{ transform: scaleY(1.15); }
    100%{ transform: scaleY(0.4); }
  }
  /* gate button */
  .gate{ position:absolute; inset:0; display:grid; place-items:center; background:rgba(6,28,43,.55); backdrop-filter: blur(2px); transition: opacity .35s ease; }
  .gate.hidden{ opacity:0; pointer-events:none; }
  .gate button{ appearance:none; border:0; border-radius:12px; padding:14px 20px; font-weight:700; background:#3aa7ff; color:#061c2b; cursor:pointer; box-shadow:0 10px 24px rgba(0,0,0,.35); }
  /* QR panel (optional – wire later) */
  .panel{ position:absolute; left:50%; bottom:6vh; transform:translateX(-50%); text-align:center; opacity:0; transition: opacity 800ms ease 400ms; }
  .panel.show{ opacity:1; }
  .hint{ font-size:.95rem; opacity:.9; }
  @media (prefers-reduced-motion: reduce){ .face{transition:none} }
</style>
</head>
<body>
<div class="stage" id="stage">
  <canvas id="dots" aria-hidden="true"></canvas>

  <div class="faceWrap">
    <img class="face" id="face" src="assets/agent.jpg" alt="Agent" />
    <!-- SVG mouth overlay. Tweak the viewBox and mouth path to line up with your image -->
    <div class="mouthWrap" aria-hidden="true">
      <svg viewBox="0 0 1000 1000" preserveAspectRatio="xMidYMid meet">
        <!-- Position this group over your image’s mouth area by tweaking translate/scale -->
        <g id="mouthGroup" transform="translate(500,600) scale(1.0)">
          <!-- simple upper/lower lip shape that we scale on Y -->
          <ellipse id="mouth" class="lip" rx="90" ry="18"></ellipse>
        </g>
      </svg>
    </div>
  </div>

  <div class="gate" id="gate" role="dialog" aria-modal="true" aria-label="Begin">
    <button id="begin">Tap to begin</button>
  </div>

  <div class="panel" id="panel">
    <div class="hint">Scan the code to continue (coming next).</div>
  </div>
</div>

<script>
  /*********** CONFIG ***********/
  const TEXT = "Hi, welcome to Case Connector. I am here to serve. I know this isn’t an easy moment, and you may be experiencing mixed feelings. I am here to help. To do that, I need to get to know you better. Please scan the code to get started.";
  // prefer male English voices (names vary across OS/browsers)
  const maleVoicePrefs = [
    /male/i, /Google UK English Male/i, /Microsoft (David|Guy|AriaNeural Male)/i, /Alex/i, /Daniel/i, /George/i
  ];
  /********* PARTICLE DOTS *********/
  const canvas = document.getElementById('dots'), ctx = canvas.getContext('2d');
  let w, h, dots=[];
  function resize(){ w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; }
  window.addEventListener('resize', resize); resize();
  function initDots(n=Math.min(600, Math.floor((w*h)/6000))){
    dots = Array.from({length:n}, () => ({
      x: Math.random()*w, y: Math.random()*h,
      r: Math.random()*1.6+0.4,
      vx: (Math.random()*2-1)*0.15, vy: (Math.random()*2-1)*0.15
    }));
  }
  initDots();
  let converge = false; // when true, dots fade to black (revealing face)
  function tick(){
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg') || '#061c2b';
    ctx.fillRect(0,0,w,h);
    ctx.globalAlpha = converge ? 0.2 : 1.0;
    ctx.fillStyle = "rgba(255,255,255,0.12)";
    for(const d of dots){
      d.x += d.vx; d.y += d.vy;
      if (d.x<0||d.x>w) d.vx*=-1;
      if (d.y<0||d.y>h) d.vy*=-1;
      ctx.beginPath(); ctx.arc(d.x,d.y,d.r,0,Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha = 1;
    requestAnimationFrame(tick);
  }
  tick();

  /*********** UI ***********/
  const stage = document.getElementById('stage');
  const gate  = document.getElementById('gate');
  const face  = document.getElementById('face');
  const panel = document.getElementById('panel');
  const mouth = document.getElementById('mouth');

  function imgReadyOrTimeout(img, ms=1000){
    if (img.complete && img.naturalWidth>0) return Promise.resolve();
    return new Promise(res=>{
      const done=()=>{cleanup();res();};
      const t=setTimeout(done, ms);
      const onl=()=>done(), one=()=>done();
      function cleanup(){clearTimeout(t); img.removeEventListener('load',onl); img.removeEventListener('error',one);}
      img.addEventListener('load',onl,{once:true}); img.addEventListener('error',one,{once:true});
    });
  }

  document.getElementById('begin').addEventListener('click', async ()=>{
    await imgReadyOrTimeout(face);
    converge = true;                 // dim dots
    stage.classList.add('started');  // fade/blur off face
    gate.classList.add('hidden');
    panel.classList.add('show');
    speak(TEXT).catch(()=>{});
  });

  /*********** SPEECH + SIMPLE LIP MOTION ***********/
  async function speak(text){
    if (!('speechSynthesis' in window)) return;
    // Wait for voices to load
    const ready = new Promise(res=>{
      const list = speechSynthesis.getVoices();
      if (list && list.length) return res();
      speechSynthesis.addEventListener('voiceschanged', ()=>res(), {once:true});
    }); await ready;

    const utter = new SpeechSynthesisUtterance(text);
    // pick a male english voice if available
    const voices = speechSynthesis.getVoices();
    const preferred = voices.find(v => /en/i.test(v.lang) && maleVoicePrefs.some(rx => rx.test(v.name||v.voiceURI||"")))
                    || voices.find(v => /en/i.test(v.lang) && /male/i.test((v.name||"")))
                    || voices.find(v => /en/i.test(v.lang))
                    || voices[0];
    if (preferred) utter.voice = preferred;

    utter.rate=1.0; utter.pitch=1.0; utter.volume=1.0;

    // word-boundary driven mouth pulses
    utter.onboundary = (e)=>{
      if (e.name==="word" || e.charIndex>=0){
        mouth.classList.remove('open'); void mouth.offsetWidth; // restart animation
        mouth.classList.add('open');
      }
    };
    utter.onend = ()=> mouth.classList.remove('open');

    speechSynthesis.cancel();
    speechSynthesis.speak(utter);
  }
</script>
</body>
</html>
