<script>
/* --- CONFIG --- */
/* Pull the text from your paragraph block */
const TEXT = document.getElementById('script').textContent.trim();

/* Optional: hard-lock a specific voice by name (exact match), e.g.
   "Google US English", "Microsoft Guy Online (Natural) - English (United States)", "Alex" */
const FORCE_VOICE_NAME = "";
/* ------------- */

/* Refs */
const playBtn     = document.getElementById('playVoice');
const beginWrap   = document.getElementById('beginWrap');
const beginBtn    = document.getElementById('begin');
const introScreen = document.getElementById('introScreen');
const qrScreen    = document.getElementById('qrScreen');

/* Show Begin after a moment */
setTimeout(()=>{ beginWrap.style.opacity = 1; }, 900);

/* Voice utils */
function getVoices(){ try { return speechSynthesis.getVoices() || []; } catch { return []; } }

async function waitForVoices(maxMs=2000){
  const t0 = performance.now();
  while (performance.now() - t0 < maxMs){
    const vs = getVoices();
    if (vs.length) return vs;
    await new Promise(r=>setTimeout(r,100));
  }
  return getVoices();
}

/* Prefer en-US male voices, then any English, then any voice */
function preferVoice(vs){
  if (FORCE_VOICE_NAME){
    const exact = vs.find(v => v.name === FORCE_VOICE_NAME);
    if (exact) return exact;
  }
  const enUS = vs.filter(v => /en[-_]?US/i.test(v.lang||""));
  const enUSMale = enUS.find(v => /(Guy|Christopher|Eric|Ryan|David|Alex|Male|US English)/i.test(`${v.name} ${v.voiceURI||""}`));
  if (enUSMale) return enUSMale;
  if (enUS.length) return enUS[0];

  const en = vs.filter(v => /en/i.test(v.lang||""));
  const enMale = en.find(v => /(Guy|Christopher|Eric|Ryan|David|Alex|Male|English)/i.test(`${v.name} ${v.voiceURI||""}`));
  if (enMale) return enMale;
  if (en.length) return en[0];

  return vs[0] || null;
}

/* Play narration (no dropdown, no highlighting) */
async function playNarration(){
  if (!('speechSynthesis' in window)) return;
  const vs = await waitForVoices();
  const voice = preferVoice(vs);

  const u = new SpeechSynthesisUtterance(TEXT);
  if (voice) u.voice = voice;
  u.rate = 0.95;   // gentle pace
  u.pitch = 0.9;   // softer male tone
  u.volume = 1.0;

  try { speechSynthesis.cancel(); speechSynthesis.speak(u); } catch {}
}

/* Wire up buttons */
playBtn.addEventListener('click', playNarration);

beginBtn.addEventListener('click', ()=>{
  try { speechSynthesis.cancel(); } catch {}
  introScreen.style.display = 'none';
  qrScreen.style.display = 'grid';
});
</script>
